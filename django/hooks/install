#!/bin/bash

set -eu

juju-log "installing pip and nginx"
sudo apt-get install -qqy nginx gunicorn python-django

juju-log "creating application dirs and log files"
# nginx conf
sudo mkdir /home/application
sudo mkdir /home/application/static
sudo touch /home/application/access.log
sudo touch /home/application/error.log
sudo chown ubuntu:ubuntu /home/application/ -R

juju_unit=`echo ${JUJU_UNIT_NAME} | sed "s/\//-/"}`
juju_charm="/var/lib/juju/units/${juju_unit}/charm"
nginx_conf="${juju_charm}/utils/nginx.conf"

juju-log "copying nginx config files"
sudo ln -s ${nginx_conf} /etc/nginx/sites-available/application.conf
sudo ln -s ${nginx_conf} /etc/nginx/sites-enabled/application.conf

juju-log "restarting nginx"
sudo /etc/init.d/nginx stop
sudo /etc/init.d/nginx start
