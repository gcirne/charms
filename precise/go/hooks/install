#!/bin/bash -l

set -u

juju-log "installing mercurial, bzr and git"
apt-get install bzr mercurial git -y -q

juju-log "creating application dirs and log files"
APPLICATION=/home/application
mkdir -p $APPLICATION
# creating the apprc file
touch $APPLICATION/apprc

juju-log "installing go"
ver=1.0.3
file=go$ver.linux-amd64.tar.gz
url=http://go.googlecode.com/files/$file

pushd $APPLICATION
    curl -sO $url
    tar zxf $file
    rm -f $file
popd

juju-log "exporting variables"
GOROOT=$APPLICATION/go export GOROOT
GOPATH=$APPLICATION/.go export GOPATH
PATH=$GOROOT/bin:$GOPATH/bin:$PATH

juju-log "creating releases dir"
mkdir -p /home/application/releases

juju-log "linking the charm"
ln -s ${CHARM_DIR} /var/lib/tsuru

sudo chown -R ubuntu:ubuntu /var/lib/tsuru/
sudo chown -R ubuntu:ubuntu /home/application/
